# 02_Design：Study Pro v1 UX設計仕様

成果物ID：DESIGN-1 / Version：1.2

最終更新：2026-02-08

対象：モバイルアプリとWeb

準拠方針：OOUIを主軸に情報設計、モバイルはHIGの標準コンポーネントを優先

参照：SB-1（戦略ブリーフ）、PT-1（P-101〜P-110）、PRIN-1、PRD-1

---

## 目次

1. 本仕様の設計原則
2. オブジェクトモデル
3. 情報設計とナビゲーション
4. 主要ビュー仕様
5. 状態設計
6. コンポーネントと表現ルール
7. 通知とプライバシー
8. DesignID一覧
9. Handoff
10. エラーハンドリング
11. オフライン対応
12. アクセシビリティ
13. AI方針とアーキテクチャ
14. 関連ドキュメント
15. 更新履歴

---

## 1. 本仕様の設計原則

### 1.1 OOUI原則

- 体験は画面ではなくオブジェクトで組み立てる
- 画面はオブジェクトの状態と行動を表現するためのビュー
- 行動は短い動詞で明確にする
- 選択肢は絞る。迷いを増やす一覧は出さない
参照 P-101, P-103

### 1.2 HIG原則

- 明確さ。文言は短く具体。主役は常に1つ
参照 P-101, P-103
- 控えめ。装飾や煽りで誘導しない。内容が主役
参照 P-107
- 深さ。タブで領域を分け、詳細は階層で掘る
- フィードバック。開始と完了が分かる。操作は即時反応
参照 P-103
- ユーザーの主導権。休む、後で、別案の選択を用意
参照 P-101, P-110

---

## 2. オブジェクトモデル

Study Proは以下のオブジェクトで構成する。各ビューはこれらのオブジェクトを表示し、行動を提供する。

### 2.1 コアオブジェクト

1. 学習領域 Domain
- 属性：名称、目的、難易度の目安
- 行動：選ぶ、変更する
1. 週目標 Weekly Goal
- 属性：週の意図、負荷、到達の定義
- 行動：設定する、調整する
参照 P-104, P-110
1. 今日の一つ Today Task
- 属性：内容、所要時間、種別 新規か復習か適用か
- 行動：これで進む、別案にする、今日は休む
参照 P-101
1. 集中セッション Focus Session
- 属性：時間 1分 3分 10分、開始時刻、完了状態
- 行動：開始する、完了する、中断する
参照 P-102, P-103
1. 想起カード Recall Item
- 属性：設問形式、難易度、自信度、次回予定
- 行動：答える、スキップする、自信度を付ける
参照 P-105
1. 証拠ログ Log Entry
- 属性：1行メモ、自信度、日時、紐づくToday Task
- 行動：記録する、見返す
参照 P-107
1. 復習キュー Review Queue
- 属性：未消化数、優先度、圧縮状態
- 行動：圧縮する、延期する、今日に混ぜる
参照 P-106, P-110

### 2.2 状態オブジェクト

1. 疲労日モード Light Mode
- 属性：短縮メニュー、Recall軽量化
- 行動：短縮で完了する
参照 P-102
1. 詰まりイベント Stuck Event
- 属性：原因タグ、発生箇所、連続回数
- 行動：原因を選ぶ、救済を選ぶ
参照 P-104
1. 復帰セッション Return Session
- 属性：離脱日数、前回要点、今日の一つ
- 行動：すぐ再開する
参照 P-110
1. 適用タスク Apply Task
- 属性：現実への差し込み、実行のしやすさ
- 行動：やる、別案、今回はしない
参照 P-108
1. 共有証明 Share Proof
- 属性：内容の粒度、公開範囲、マスキング
- 行動：生成する、送る、範囲を選ぶ
参照 P-109

---

## 3. 情報設計とナビゲーション

### 3.1 モバイルのタブ

- 今日
- 履歴
- 設定

HIGに沿い、タブは少数で固定。主要行動は今日に集約する。

参照 P-101, P-103

### 3.2 Webの役割

- 週次振り返りの閲覧と調整
- 履歴の一覧と検索
- 週目標の調整と通知設定

モバイルは実行。Webは振り返りと調整。

参照 P-107, P-106

---

## 4. 主要ビュー仕様

この節は画面ではなく、オブジェクトと行動の提供として定義する。

### 4.1 今日ビュー Today View

対象オブジェクト：Today Task、Review Queue、Light Mode

参照 P-101, P-102, P-106

表示

- 今日の一つ Today Task を最上段に固定
- 選択肢は3つまで
    - これで進む
    - 別案にする
    - 今日は休む

別案にする

- シートで候補を2つ提示
- 追加の探索一覧は出さない
- 候補は週目標と矛盾しない範囲に限定
参照 P-101

復習は今日に混ぜる

- 復習キューの存在は主張しない
- 今日の一つが復習になる場合がある
参照 P-106

### 4.2 集中ビュー Focus View

対象オブジェクト：Focus Session、Light Mode

参照 P-102, P-103

表示

- 1分 3分 10分 の選択
- 疲労日モードでは 1分と3分を先頭に固定

行動

- 開始する
- 完了する

### 4.3 想起ビュー Recall View

対象オブジェクト：Recall Item

参照 P-105

表示

- 2択1問を基本
- 正誤の強調は弱くする

行動

- 答える
- スキップする
- 自信度 1〜4 を付ける

スキップ時

- 次回の復習に回す
- 罪悪感を生む表示はしない
参照 P-105, P-106

### 4.4 記録ビュー Log View

対象オブジェクト：Log Entry

参照 P-107

表示と入力

- 1行入力
- 自信度

行動

- 記録して完了へ進む

### 4.5 完了ビュー Done View

対象オブジェクト：Log Entry、Today Task、Review Queue

参照 P-103, P-107

表示

- 今日の証拠としてログを1つ見せる
- 次の一手を1つだけ提示

### 4.6 詰まり救済ビュー Rescue View

対象オブジェクト：Stuck Event

参照 P-104

発動条件例

- Recall連続失敗
- Focus開始後の中断が続く
- 休むの連続選択

表示

- 原因選択 最大3つ
    - 難しい
    - 何から手をつけるか分からない
    - 時間が足りない

救済提示 最大3つ

- 分割する
- 例を見てからやる
- 今日は易しくする

ガード

- 長文説明は禁止
- 選択後は今日ビューか集中ビューに戻す

### 4.7 復帰ビュー Return View

対象オブジェクト：Return Session

参照 P-110

表示

- 前回の要点 1行
- 今日の一つ

出さない

- 未消化の山
- 達成率の強調
- 説明の連続

### 4.8 適用ビュー Apply View

対象オブジェクト：Apply Task

参照 P-108

表示タイミング

- 7日以降に週1回
- 週次振り返り後に差し込み

行動

- やる
- 別案
- 今回はしない

### 4.9 共有ビュー Share View

対象オブジェクト：Share Proof

参照 P-109

方針

- 初期は非表示、もしくは段階解放
- 既定は個別共有
- 公開範囲の選択は強めに制御
- 比較を誘発するランキングや一覧は作らない

---

## 5. 状態設計

### 初回

- Domain選択と週目標を最小入力で終える
- 今日の一つを完了まで通し、完了ビューで価値を示す
参照 P-103, P-101

### 通常日

- 今日の一つを提示し、集中と想起と記録で完了させる
参照 P-101, P-105, P-107

### 疲労日

- 短縮で完了できる導線を先に出す
- 想起は1問またはスキップ可能
参照 P-102, P-105

### 詰まり

- 救済は短く、原因選択と打ち手提示のみ
参照 P-104

### 復帰

- 要点と今日の一つだけ提示し再開させる
参照 P-110

---

## 6. コンポーネントと表現ルール

### モバイル

- 標準のタブバーとナビゲーション階層を使う
- シートは標準のモーダルシートを使う
- ボタンとタップ領域は十分に確保する
- 文言は短く、命令ではなく行動の選択肢として提示する
参照 P-101

### Web

- モバイルと同じオブジェクトを扱う
- 週次と履歴は閲覧と調整に特化
- 実行のための導線は最小にする

---

## 7. 通知とプライバシー

参照 P-110, P-102

通知方針

- 初期は控えめ
- 設定で頻度と時間帯を制御できる
- 連続未利用時は復帰ビューへの導線に寄せる

プライバシー

- 共有は明示行動のみに限定
- 公開範囲は既定で狭くする
- 学習内容の外部送信が起きる場合は明確な説明を出す

---

## 8. DesignID一覧

- D-001 Today提示と拒否権
参照 P-101
- D-002 初回で完了まで導く導線
参照 P-103
- D-003 疲労日短縮モード
参照 P-102
- D-004 詰まり救済
参照 P-104
- D-005 想起の再認設計と逃がし
参照 P-105
- D-006 分散復習の可変と圧縮
参照 P-106
- D-007 証拠の可視化
参照 P-107
- D-008 適用ミニ課題
参照 P-108
- D-009 共有の段階解放と範囲制御
参照 P-109
- D-010 復帰導線
参照 P-110
- D-011 Web週次振り返り
参照 P-107, P-103
- D-012 通知の制御
参照 P-102, P-110

---

## 9. Handoff

この仕様はOOUIのオブジェクトを基準として実装と画面設計を進める。

次に作る成果物は計測表と実験仕様書。

---

## 10. エラーハンドリング

### 10.1 エラー分類と対応方針

#### ネットワークエラー

- **発生場面**: Today提示取得、AI生成、Recall取得、ログ送信
- **対応**:
  - 最大3回のリトライ（指数バックオフ）
  - リトライ失敗時はキャッシュまたはローカル生成でフォールバック
  - ユーザーへの通知は最小限（「接続に時間がかかっています」など）

#### AI生成エラー

- **発生場面**: Today提示生成、Recall生成、詰まり救済提案
- **対応**:
  - タイムアウト時（5秒以上）は事前定義済みのフォールバックコンテンツを表示
  - エラーログを送信し、次回の改善に反映
  - ユーザーには「別の提案」として再生成を促す

#### データ同期エラー

- **発生場面**: ログ保存、Recall結果送信、週目標更新
- **対応**:
  - ローカルにキューイングし、次回接続時に自動再送
  - 同期状態はステータスバーで控えめに表示
  - ユーザーの操作は中断しない

#### 認証エラー

- **発生場面**: セッション期限切れ
- **対応**:
  - 自動再認証を試行
  - 失敗時はログイン画面へ遷移（現在の状態は保持）

### 10.2 エラーメッセージ表現規約

- 技術用語を使わない（「サーバー」「API」などの表現を避ける）
- 具体的な行動を示す（「もう一度試す」「別の提案を見る」など）
- 自己否定を誘発しない（「失敗しました」ではなく「うまくいきませんでした」）

参照：P-101, P-104

---

## 11. オフライン対応

### 11.1 オフライン時の動作方針

Study Pro は原則オンラインを前提とするが、一時的なオフライン状態でも最小限の操作を継続できる設計とする。

### 11.2 オフライン時に可能な操作

- **Focus セッション**: タイマーは動作し、完了状態をローカルに保存
- **Log 記録**: ローカルに保存し、次回オンライン時に同期
- **履歴閲覧**: キャッシュされた過去ログを表示

### 11.3 オフライン時に制限される操作

- **Today 提示の取得**: キャッシュがない場合は「今は接続できません」と表示
- **Recall 生成**: 新規の想起カードは取得不可、事前キャッシュがあれば表示
- **詰まり救済**: AI 生成が必要なため利用不可

### 11.4 同期戦略

- オンライン復帰時に自動的にバックグラウンドで同期
- 同期中も操作は継続可能
- 競合が発生した場合は「最新を優先」し、ローカル変更は履歴として保持

参照：P-103, P-107

---

## 12. アクセシビリティ

### 12.1 基本方針

- WCAG 2.1 レベルAA を目標とする
- HIG および Material Design のアクセシビリティガイドラインに準拠
- 疲労や集中困難を前提とした設計を行う

参照：P-102

### 12.2 視覚

- **コントラスト比**: テキストと背景は最低 4.5:1
- **フォントサイズ**: 最小 16px（本文）、14px（補足）
- **動的タイプ**: OSの文字サイズ設定に対応
- **色だけに依存しない**: 状態の表現は色＋アイコン＋テキストで行う

### 12.3 聴覚

- 音声フィードバックは補助的に使用し、必須情報は視覚でも提供
- 通知音は設定でオフ可能

### 12.4 操作

- **タップ領域**: 最小 44×44pt（iOS）、48×48dp（Android）
- **キーボードナビゲーション**: Webではすべての操作をキーボードで完結可能
- **音声コントロール**: VoiceOver / TalkBack で主要フローを完結可能
- **スクリーンリーダー対応**: すべてのUI要素に適切なラベルを付与

### 12.5 認知負荷への配慮

- 1画面に1つの主要行動
- 選択肢は最大3つまで
- 説明文は短く、必要に応じて折りたたみ
- 進捗は視覚的に明示（プログレスバー、ステップ表示）

参照：P-101, P-103, P-104

---

## 13. AI方針とアーキテクチャ

### 13.1 AI導入の基本方針

Study Pro v1（MVP）では、AI機能は実装しない。AIは将来的な拡張として位置づけ、差し替え可能な構造のみを用意する。

#### 原則

1. **AI未導入でも体験が成立すること**
   - すべての学習体験はルールベースで完結する
   - AIは補助であり、必須機能ではない

2. **段階的導入が可能なこと**
   - Feature Flagで機能単位にAIを有効化できる
   - AI有効化後も、フォールバックとしてルールベースが動作する

3. **セキュリティの保証**
   - APIキーやSecretsはサーバー側のみで管理
   - クライアント（Web/モバイル）に機密情報を露出しない
   - クライアントは常にサーバーAPIを経由してAI機能にアクセス

4. **実装の差し替え容易性**
   - AI呼び出しはインターフェースで抽象化
   - 実装（スタブ/OpenAI/Anthropic）を差し替えても、呼び出し側は変更不要

### 13.2 現在の実装構造

#### スタブ実装（MVP）

現在は `MockAIService` として以下の機能をスタブで提供：

- **Today Task生成**: 固定テンプレートから選択
- **別案生成**: ルールベース（難易度・時間維持、タイプ変更優先）
- **Recall Item生成**: 固定テンプレート（3種類）
- **詰まり救済提案**: 固定メッセージ

参照：`packages/web/src/services/aiService.ts`

#### インターフェース

```typescript
export interface IAIService {
  generateTodayTask(context: AIContext): Promise<TodayTask>;
  generateAlternatives(currentTask: TodayTask, reason: string, context: AIContext): Promise<TodayTask[]>;
  generateRecallItem(content: string, difficulty: 1 | 2 | 3): Promise<RecallItem>;
  generateIntervention(stuckContext: StuckContext): Promise<Intervention>;
}
```

差し替えポイント：
```typescript
// 現在
export const aiService = new MockAIService();

// 将来（環境変数で切り替え）
export const aiService = 
  import.meta.env.VITE_AI_ENABLED === 'true'
    ? new OpenAIService()
    : new MockAIService();
```

### 13.3 Feature Flag設計

#### AI_ENABLED フラグ

| 環境変数 | 値 | 動作 |
|---|---|---|
| `AI_ENABLED` | `false`（デフォルト） | スタブ実装を使用、外部AI APIは呼ばない |
| `AI_ENABLED` | `true`（将来） | OpenAI/Anthropic APIを使用 |

#### フラグの配置

- **サーバー側**: 環境変数 `AI_ENABLED`（`.env`）
- **クライアント側**: サーバーAPIから「AI機能の利用可否」を取得
  - クライアントは環境変数を直接参照しない
  - フラグ値自体ではなく、「現在AIが使える/使えない」という状態のみを受け取る

#### フラグOFF時の挙動

- すべての学習体験がルールベースで動作
- Today Task: 固定テンプレート
- 別案: ルールベース生成（難易度・時間維持）
- Recall: 固定テンプレート（3種類）
- 詰まり救済: 固定メッセージ

ユーザーにはAIの有無を明示しない（透過的に動作）

### 13.4 将来のAI統合設計

#### サーバー側APIエンドポイント（将来実装）

クライアントは直接外部AIにアクセスせず、サーバーAPIを経由：

```
POST /api/ai/today-task
POST /api/ai/alternatives
POST /api/ai/recall-item
POST /api/ai/intervention
```

各エンドポイントの動作：
- `AI_ENABLED=false`: ルールベース応答を返す
- `AI_ENABLED=true`: OpenAI/Anthropic APIを呼び出し、結果を返す

#### AI実装の切り替え例

```typescript
// packages/server/src/services/aiService.ts（将来）
export class OpenAIService implements IAIService {
  private openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY, // サーバー側のみ
  });

  async generateTodayTask(context: AIContext): Promise<TodayTask> {
    const response = await this.openai.chat.completions.create({
      model: process.env.AI_MODEL || 'gpt-4',
      messages: [
        {
          role: 'system',
          content: 'あなたは学習タスクを提案するアシスタントです。',
        },
        {
          role: 'user',
          content: `
            ドメイン: ${context.userProfile.currentDomain.name}
            週目標: ${context.weeklyGoal.frequency}回/週
            疲労度: ${context.fatigueLevel || 'medium'}
            適切なタスクを1つ提案してください。
          `,
        },
      ],
    });
    
    return parseAIResponse(response);
  }
}

// 環境変数で切り替え
export const aiService = 
  process.env.AI_ENABLED === 'true'
    ? new OpenAIService()
    : new MockAIService();
```

### 13.5 セキュリティと機密管理

#### 禁止事項

- ❌ クライアントにAPIキーを配置
- ❌ 環境変数を直接フロントエンドに露出（`VITE_OPENAI_API_KEY` など）
- ❌ リポジトリに `.env` ファイルをコミット
- ❌ ログに機密情報（APIキー、ユーザーの個人情報）を出力

#### 必須対応

- ✅ APIキーは `.env` ファイルで管理、`.gitignore` に追加
- ✅ `.env.example` でテンプレートを提供
- ✅ サーバー側のみで外部APIにアクセス
- ✅ クライアントは認証トークンでサーバーAPIにアクセス
- ✅ 本番環境ではSecretsマネージャー（AWS Secrets Manager等）を使用

参照：`.env.example`, `.gitignore`

### 13.6 テストと確認

#### 自動テスト（将来実装）

```typescript
describe('AIService', () => {
  it('AI_ENABLED=falseではスタブが動作する', async () => {
    process.env.AI_ENABLED = 'false';
    const service = createAIService();
    const task = await service.generateTodayTask(mockContext);
    expect(task.source).toBe('default');
  });

  it('AI_ENABLED=trueでは外部APIを呼ぶ', async () => {
    process.env.AI_ENABLED = 'true';
    const service = createAIService();
    // モックAPIで検証
  });

  it('クライアントにAPIキーが露出しない', () => {
    const clientEnv = getClientEnvironment();
    expect(clientEnv.OPENAI_API_KEY).toBeUndefined();
  });
});
```

#### 手動確認手順

1. **フラグOFF確認**:
   ```bash
   echo "AI_ENABLED=false" > .env
   npm run dev
   # → すべての機能がルールベースで動作
   ```

2. **フラグON確認**（将来）:
   ```bash
   echo "AI_ENABLED=true" > .env
   echo "OPENAI_API_KEY=sk-..." >> .env
   npm run dev
   # → AI機能が有効化
   ```

3. **機密露出確認**:
   - ブラウザの開発者ツールで `window` を確認
   - `OPENAI_API_KEY` などの文字列が存在しないことを確認
   - ネットワークタブでクライアント→サーバーAPIのリクエストのみを確認

参照：`AI_INTEGRATION_TEST.md`（将来作成）

### 13.7 既知の制約と次の候補

#### 現在の制約

- AI機能はスタブのみ、実際のAI APIは未実装
- サーバー側エンドポイントは未実装
- Feature Flagは環境変数のみ（動的な切り替えは未対応）

#### 次の実装候補

1. **サーバー側実装**
   - Node.js + Express（または Next.js API Routes）
   - AI APIエンドポイントの実装
   - 認証・認可の実装

2. **AI統合**
   - OpenAI API統合
   - プロンプトエンジニアリング
   - レスポンスのパース・検証

3. **Feature Flagの高度化**
   - 動的フラグ切り替え（LaunchDarkly等）
   - ユーザー単位・グループ単位の段階的ロールアウト
   - A/Bテストとの統合

4. **フォールバック機構**
   - AI API障害時の自動フォールバック
   - レスポンスタイムアウト時のルールベース代替
   - エラーログとアラート

参照：`docs/05_Decisions.md` DEC-20260208-010

---

## 14. 関連ドキュメント

- **00_Principles.md**：サービス設計原則
- **01_PRD.md**：プロダクト要求仕様
- **03_Metrics.md**：計測定義とイベント設計
- **04_Experiments.md**：A/B実験仕様
- **05_Decisions.md**：意思決定ログ

---

## 15. 更新履歴

| 日付 | Version | 変更内容 | 担当者 |
|---|---|---|---|
| 2026-02-08 | 1.3 | AI方針とアーキテクチャの章を追加、Feature Flag設計、セキュリティ方針 | - |
| 2026-02-08 | 1.2 | エラーハンドリング、オフライン対応、アクセシビリティの章を追加、目次追加 | - |
| - | 1.1 | 初版作成 | - |