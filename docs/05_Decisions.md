# 05_Decisions：意思決定ログ

成果物ID：DEC-1 / Version：1.1

最終更新：2026-02-08

参照：PRIN-1、PRD-1、DESIGN-1、METRICS-1、EXP-1

---

## 目次

0. 目的
1. 運用ルール
2. インデックス
3. 1件のテンプレート
4. 記録の例
5. 確定した決定事項
6. 関連ドキュメント
7. 更新履歴

---

## 0. 目的

- 重要な判断を、後から追跡できる形で残す
- 何を根拠に、何を捨て、何を採用したかを明確にする
- 実験や計測結果と紐づけて、学びを次の判断に再利用する

---

## 1. 運用ルール
- 追加するタイミング  
  - 仕様を固定したとき  
  - A/Bの結論を確定したとき  
  - KPI定義や計測仕様を変更したとき  
  - 優先順位を変更したとき  
  - 重大なリスク対応方針を決めたとき

- 記載の粒度  
  - 迷った選択肢があったものだけ記録する  
  - 1件あたり3分で書ける長さにする  
  - 根拠は数字か観察事実に限定する  
  - 推測は必ず ASSUMPTION と明記する

- 命名規則  
  - DEC-YYYYMMDD-001 形式  
  - 例 DEC-20260208-001

---

## 2. インデックス

| DecisionID | 日付 | 決定内容 | 状態 | 影響範囲 | 根拠リンク |
|---|---|---|---|---|---|
| DEC-20260208-001 | 2026-02-08 | Todayに拒否権（別案・休む）を必須で含める | Proposed | PRD § 8.1, Design D-001 | X-001 |
| DEC-20260208-002 | 2026-02-08 | イベント名を03_Metricsに統一（today_offer_* 等） | Accepted | PRD § 14, Metrics § 6 | - |
| DEC-20260208-003 | 2026-02-08 | North Star Metricを「週目標達成率」に設定 | Accepted | PRD § 6, Metrics § 2 | - |
| DEC-20260208-004 | 2026-02-08 | MVP技術スタックをReact Native + Node.js + PostgreSQLとする（ASSUMPTION） | Proposed | PRD § 17 | - |
| DEC-20260208-005 | 2026-02-08 | OOUIオブジェクトモデルをTypeScriptで定義 | Accepted | Design § 2, 全実装 | - |
| DEC-20260208-006 | 2026-02-08 | データ永続化をlocalStorage優先、将来API化可能な設計 | Accepted | storageService | - |
| DEC-20260208-007 | 2026-02-08 | AIサービスをMock実装、将来OpenAI切り替え可能 | Accepted | aiService | - |
| DEC-20260208-008 | 2026-02-08 | Web/モバイル共通化をReact+React Routerで実現 | Accepted | packages/web | - |
| DEC-20260208-009 | 2026-02-08 | Day1はルールベース実装（AI禁止） | Accepted | Day1フロー全体 | - |
| DEC-20260208-010 | 2026-02-08 | MVPではAI機能は実装せず、差し替え可能な構造のみ用意 | Accepted | 全体アーキテクチャ | - |
| DEC-20260208-011 | 2026-02-08 | 詰まり救済はテンプレート版で実装、LLM差し替え可能な設計 | Accepted | CoachService | - |

---

## 3. 1件のテンプレート

## DecisionID
DEC-YYYYMMDD-001

### 日付
YYYY-MM-DD

### 決定内容
- 何を決めたかを1文で書く

### 背景
- なぜ今決める必要があるか
- 関連する課題や論点

### 対象範囲
- 対象ユーザー
- 対象画面または対象機能
- 対象期間

### 選択肢
- Option A  
- Option B  
- Option C  

### 採用
- 採用した選択肢と、その要点

### 採用理由
- 事実ベースの根拠  
  - 計測値  
  - ユーザーテスト観察  
  - 障害や運用制約  
- 期待する効果  
  - 主要KPIへの影響仮説

### 棄却理由
- なぜ他の選択肢を採用しなかったか

### ASSUMPTION
- 未検証の前提を列挙する  
- 検証方法も一言で添える

### リスクと対策
- 想定リスク
- 予防策
- 発生時対応

### 成功条件と失敗条件
- 成功条件  
  - 例 Time-to-start の p75 がX秒以下  
- 失敗条件  
  - 例 Day2 継続が悪化したらロールバック

### ロールバック方針
- どこまで戻すか
- いつ判断するか

### 影響するドキュメント
- 01_PRD  
- 02_Design  
- 03_Analytics  
- 04_Experiments  

### 関連リンク
- ExperimentID  
- ダッシュボード  
- 仕様PR  
- デザインURL

### オーナー
- 名前

### ステータス
- Proposed / Accepted / Implemented / Reverted

### 次回レビュー日
YYYY-MM-DD

---

## 4. 記録の例
> これは記入例。実際に決定した事実ではない。

## DecisionID
DEC-YYYYMMDD-001

### 日付
YYYY-MM-DD

### 決定内容
- Today提示に、別案に変える と 今日は休む を必須で含める

### 背景
- 提示が押し付けに見えると、初期離脱のリスクが高い

### 対象範囲
- Todayカード
- 初回と通常利用

### 選択肢
- Option A 提示のみ  
- Option B 提示と別案に変える  
- Option C 提示と別案に変えると今日は休む  

### 採用
- Option C

### 採用理由
- 提案差し替えと休む を許容することで、ユーザーの主導感を損ねにくい  
- 計測で拒否や差し替えが多い場合は提案ロジック改善に繋げられる

### 棄却理由
- Option A は拒否の出口がなく不信につながる可能性がある  
- Option B は疲労時の出口が弱い

### ASSUMPTION
- 休む を出しても継続率が下がらない  
- 検証方法 Day2 Day7 と休む率の相関を見る

### リスクと対策
- リスク 休む が常用され学習が進まない  
- 対策 休む を選んだ翌日は短縮メニューを提示する

### 成功条件と失敗条件
- 成功条件 Time-to-start 改善 提案受諾か差し替えの合計が一定以上
- 失敗条件 Day2 継続が悪化したら表現または導線を修正

### ロールバック方針
- Todayカードから 今日は休む を外し 別案に変える のみに戻す

### 影響するドキュメント
- 02_Design Todayカード仕様
- 03_Analytics today_offer_* イベント
- 04_Experiments A/B仕様

### 関連リンク
- X-00x
- ダッシュボードURL

### オーナー
- 

### ステータス
- Proposed

### 次回レビュー日
YYYY-MM-DD

---

## 5. 確定した決定事項

以下は、本ドキュメント整備時（2026-02-08）に確定した主要な決定事項である。

---

### DEC-20260208-001

#### 日付
2026-02-08

#### 決定内容
Todayカードに「別案に変える」と「今日は休む」を必須で含める

#### 背景
- Todayの提示が押し付けに見えると、初期離脱のリスクが高い
- ユーザーの主導権を保つことが、継続の前提である（PRIN-1 § 6参照）

#### 対象範囲
- Todayカード（モバイル・Web）
- 初回導線と通常利用の両方

#### 選択肢
- **Option A**: 提示のみ（拒否権なし）
- **Option B**: 提示＋「別案に変える」
- **Option C**: 提示＋「別案に変える」＋「今日は休む」（採用）

#### 採用
Option C

#### 採用理由
- 拒否権を与えることで、ユーザーの主導感を損ねにくい（P-101参照）
- 「休む」を出すことで、疲労日の出口を明示的に用意できる（P-102参照）
- 計測で拒否や差し替えが多い場合は、提案ロジック改善に繋げられる

#### 棄却理由
- **Option A**: 拒否の出口がなく、不信や離脱につながる可能性が高い
- **Option B**: 疲労時の出口が弱く、無理な継続を促す懸念がある

#### ASSUMPTION
- **ASSUMPTION-09**: 「今日は休む」を出しても継続率が下がらない
  - 検証方法：X-001（Day2 / Day7 と休む率の相関を見る）

#### リスクと対策
- **リスク**: 「休む」が常用され、学習が進まない
- **対策**: 休むを選んだ翌日は短縮メニューを優先提示する（P-102参照）

#### 成功条件と失敗条件
- **成功条件**: Time-to-start 改善、提案受諾または差し替えの合計が一定以上
- **失敗条件**: Day2 継続が悪化したら、表現または導線を修正

#### ロールバック方針
- Todayカードから「今日は休む」を外し、「別案に変える」のみに戻す

#### 影響するドキュメント
- 01_PRD.md § 8.1
- 02_Design.md § 4.1, D-001
- 03_Metrics.md § 6 today_offer_*
- 04_Experiments.md X-001

#### 関連リンク
- X-001

#### オーナー
PM

#### ステータス
Proposed（X-001で検証予定）

#### 次回レビュー日
実験完了後（予定：2週間後）

---

### DEC-20260208-002

#### 日付
2026-02-08

#### 決定内容
イベント名を03_Metricsの定義に統一し、PRDの記載を修正

#### 背景
- PRDとMetricsでイベント名が不一致（例: `today_shown` vs `today_offer_shown`）
- 実装とデータ分析で混乱が生じるリスクがある

#### 対象範囲
- すべての計測イベント

#### 選択肢
- **Option A**: PRDの命名をMetricsに合わせる（採用）
- **Option B**: Metricsの命名をPRDに合わせる

#### 採用
Option A

#### 採用理由
- 03_Metricsの命名は、すでに詳細なプロパティ定義と紐づいている
- 計測基盤の実装はMetricsを基準に進めるため、こちらを正とする

#### 棄却理由
- **Option B**: Metricsの修正範囲が広く、プロパティ定義との整合性維持が困難

#### ASSUMPTION
なし（確定事項）

#### リスクと対策
- **リスク**: 既存の実装がある場合、修正コストが発生
- **対策**: MVP開発前の決定のため、影響は最小限

#### 成功条件と失敗条件
- **成功条件**: PRDとMetricsのイベント名が100%一致
- **失敗条件**: なし

#### ロールバック方針
不要

#### 影響するドキュメント
- 01_PRD.md § 8, § 14
- 03_Metrics.md § 6

#### 関連リンク
なし

#### オーナー
PM + データアナリスト

#### ステータス
Accepted（実装済み）

#### 次回レビュー日
不要

---

### DEC-20260208-003

#### 日付
2026-02-08

#### 決定内容
North Star Metricを「週目標達成率（Week Goal Completion Rate）」に設定

#### 背景
- PRDには暫定NSMとして記載があったが、Metricsには明記されていなかった
- NSMはチーム全体の意思決定の軸となるため、明確化が必要

#### 対象範囲
- 全体戦略、KPI設計

#### 選択肢
- **Option A**: Day7 継続率
- **Option B**: 週目標達成率（採用）
- **Option C**: 学習セッション完了数

#### 採用
Option B

#### 採用理由
- 学習継続と成果の両方を反映する（PRIN-1 § 8参照）
- ユーザーの主観的な達成感と相関が高い
- 短期的な施策効果と長期的な定着の両方を測定できる

#### 棄却理由
- **Option A**: 継続は測れるが、学習成果の視点が弱い
- **Option C**: 量は測れるが、質や達成感が測れない

#### ASSUMPTION
- **ASSUMPTION-10**: 週目標達成率が高いユーザーは、長期継続率も高い
  - 検証方法：コホート分析（12週間追跡）

#### リスクと対策
- **リスク**: 週目標の設定が適切でない場合、NSMが機能しない
- **対策**: 週目標設定のオンボーディングを丁寧に設計（PRD § 7参照）

#### 成功条件と失敗条件
- **成功条件**: NSMが週次で安定的に測定でき、施策効果と相関する
- **失敗条件**: NSMと継続率・満足度の相関が低い場合は再検討

#### ロールバック方針
NSM自体の変更（別の指標に切り替え）

#### 影響するドキュメント
- 01_PRD.md § 6
- 03_Metrics.md § 2

#### 関連リンク
なし

#### オーナー
PM

#### ステータス
Accepted

#### 次回レビュー日
MVP運用開始後4週間

---

### DEC-20260208-004

#### 日付
2026-02-08

#### 決定内容
MVP技術スタックをReact Native + Node.js + PostgreSQL + Redisとする（ASSUMPTION）

#### 背景
- PRDに技術的前提が欠けていたため、開発着手前に明確化する必要がある
- チーム構成（開発2名）とリリース期限（4週間）を考慮した選定

#### 対象範囲
- フロントエンド、バックエンド、データベース

#### 選択肢
- **Option A**: React Native + Node.js + PostgreSQL（採用）
- **Option B**: Swift/Kotlin ネイティブ + Python + PostgreSQL
- **Option C**: Flutter + Go + PostgreSQL

#### 採用
Option A

#### 採用理由
- React Nativeは、iOS/Androidを1コードベースで開発でき、リソース効率が高い
- Node.jsは、TypeScript統一により、フロントエンドとの型共有が容易
- PostgreSQLは、リレーショナルデータと分散復習ロジックに適している
- Redisは、セッション管理とキャッシュに有効

#### 棄却理由
- **Option B**: ネイティブ開発は品質が高いが、開発期間とリソースが不足
- **Option C**: Flutterは学習コストが高く、チームの経験値が不足

#### ASSUMPTION
- **ASSUMPTION-11**: React NativeでTime-to-startの目標（p75 30秒以内）を達成できる
  - 検証方法：プロトタイプでの計測
- **ASSUMPTION-12**: PostgreSQLで分散復習ロジックが十分なパフォーマンスを発揮する
  - 検証方法：負荷テスト（1000ユーザー想定）

#### リスクと対策
- **リスク**: React Nativeのパフォーマンスが不足する場合がある
- **対策**: 重要画面（Today、Focus）はネイティブモジュールで最適化

#### 成功条件と失敗条件
- **成功条件**: MVP開発が4週間以内に完了し、主要KPIが取得できる
- **失敗条件**: Time-to-startが目標を達成できない場合は、ネイティブ移行を検討

#### ロールバック方針
ネイティブアプリへの段階移行（iOS優先）

#### 影響するドキュメント
- 01_PRD.md § 17

#### 関連リンク
なし

#### オーナー
テックリード

#### ステータス
Proposed（プロトタイプで検証予定）

#### 次回レビュー日
プロトタイプ完成後（2週間後）

---

### DEC-20260208-005

#### 日付
2026-02-08

#### 決定内容
OOUIオブジェクトモデルをTypeScriptで完全に定義し、画面構造の土台とする

#### 背景
- docs/02_Design.md § 2 でOOUIオブジェクトモデルが定義されている
- 画面は「オブジェクトの操作」として設計する必要がある
- 型定義により、実装の一貫性を保つ

#### 対象範囲
- packages/web/src/types/index.ts
- 全画面コンポーネント

#### 選択肢
- **Option A**: TypeScriptで完全な型定義（採用）
- **Option B**: PropTypesでの緩い型付け
- **Option C**: 型なしのJavaScript

#### 採用
Option A

#### 採用理由
- TypeScriptの型システムにより、コンパイル時にエラーを検出できる
- IDEの自動補完により、開発効率が向上する
- OOUIオブジェクトの属性と行動が明確になる
- リファクタリングが安全に行える

#### 棄却理由
- **Option B**: 型チェックが実行時になり、エラー検出が遅れる
- **Option C**: 型安全性がなく、大規模化に対応できない

#### ASSUMPTION
なし（確定事項）

#### リスクと対策
- **リスク**: 型定義の学習コストが発生する
- **対策**: 既存のコードベースを参考にし、段階的に習得

#### 成功条件と失敗条件
- **成功条件**: すべてのOOUIオブジェクトが型定義され、実装で使用される
- **失敗条件**: なし

#### ロールバック方針
不要（TypeScriptは確定）

#### 影響するドキュメント
- 02_Design.md § 2 オブジェクトモデル
- packages/web/src/types/index.ts

#### 関連リンク
なし

#### オーナー
開発チーム

#### ステータス
Accepted

#### 次回レビュー日
不要

---

### DEC-20260208-006

#### 日付
2026-02-08

#### 決定内容
データ永続化をlocalStorage優先とし、将来的にサーバーAPI化可能な設計とする

#### 背景
- MVP段階ではサーバー不要でローカル完結が望ましい
- 将来的にはサーバー同期が必要になる
- インターフェースを統一し、実装を差し替え可能にする

#### 対象範囲
- packages/web/src/services/storageService.ts

#### 選択肢
- **Option A**: localStorage + インターフェース抽象化（採用）
- **Option B**: 最初からサーバーAPI実装
- **Option C**: IndexedDBでのローカル保存

#### 採用
Option A

#### 採用理由
- MVP開発が高速化（サーバー不要）
- デバッグが容易（ブラウザ開発者ツールで確認可能）
- インターフェースを統一することで、将来の切り替えが容易
- ユーザーデータがブラウザに残るため、初期段階でも継続利用可能

#### 棄却理由
- **Option B**: MVP段階でサーバー開発コストが高すぎる
- **Option C**: IndexedDBは複雑で、localStorageで十分

#### ASSUMPTION
- **ASSUMPTION-13**: localStorage の5MB制限で当面は問題ない
  - 検証方法: 1ヶ月分のデータサイズを計測
- **ASSUMPTION-14**: サーバーAPI化時にデータ移行が可能
  - 検証方法: マイグレーション機能の実装

#### リスクと対策
- **リスク**: ブラウザキャッシュクリアでデータが消える
- **対策**: 定期的なエクスポート機能を追加（将来）
- **リスク**: 複数デバイス間での同期ができない
- **対策**: サーバーAPI実装時に解決

#### 成功条件と失敗条件
- **成功条件**: IStorageインターフェースが定義され、LocalStorageServiceが実装される
- **失敗条件**: データ保存が5MB制限を超える

#### ロールバック方針
不要（localStorage は MVP の確定事項）

#### 影響するドキュメント
- packages/web/src/services/storageService.ts

#### 関連リンク
なし

#### オーナー
開発チーム

#### ステータス
Accepted

#### 次回レビュー日
MVP運用開始後1ヶ月（データサイズ確認）

---

### DEC-20260208-007

#### 日付
2026-02-08

#### 決定内容
AIサービスをMock実装とし、将来的にOpenAI/Anthropic API切り替え可能な設計とする

#### 背景
- AI生成はプロダクトの重要機能だが、MVP段階ではコストとレイテンシが課題
- インターフェースを先に確定し、実装を後で差し替える
- 仮データでもユーザー体験のテストが可能

#### 対象範囲
- packages/web/src/services/aiService.ts

#### 選択肢
- **Option A**: Mock AI + インターフェース抽象化（採用）
- **Option B**: 最初からOpenAI API実装
- **Option C**: AI機能なし（人手でタスク作成）

#### 採用
Option A

#### 採用理由
- MVP開発が高速化（AI APIコストゼロ）
- レイテンシゼロで動作確認可能
- IAIServiceインターフェースにより、将来の切り替えが容易
- 仮データでもユーザーフローの検証が可能

#### 棄却理由
- **Option B**: API コストが未確定、レイテンシが体験を損なう可能性
- **Option C**: AI機能がプロダクトの差別化要素のため、インターフェースは必要

#### ASSUMPTION
- **ASSUMPTION-15**: Mock AIでもユーザー体験の基本フローは検証できる
  - 検証方法: ユーザーテスト（5人）
- **ASSUMPTION-16**: OpenAI APIレイテンシが2秒以内に収まる
  - 検証方法: プロトタイプでの計測（PRD § 19.3参照）

#### リスクと対策
- **リスク**: Mock AIと実AIで体験が大きく変わる
- **対策**: 早期にAI統合テストを実施
- **リスク**: AI生成の品質が想定より低い
- **対策**: フィードバックループを組み込む（提案受諾率で監視）

#### 成功条件と失敗条件
- **成功条件**: IAIServiceインターフェースが定義され、MockAIServiceが実装される
- **失敗条件**: なし（MVP段階では Mock で問題ない）

#### ロールバック方針
不要（インターフェース設計は確定）

#### 影響するドキュメント
- packages/web/src/services/aiService.ts
- 01_PRD.md § 18 ASSUMPTION

#### 関連リンク
- PRD-1 § 19 ASSUMPTION

#### オーナー
開発チーム

#### ステータス
Accepted

#### 次回レビュー日
AI統合時（MVP後）

---

### DEC-20260208-008

#### 日付
2026-02-08

#### 決定内容
Web/モバイル共通化をReact + React Routerで実現し、レスポンシブデザインで対応

#### 背景
- PRD では「Web/モバイル両対応」が要件
- React Native ではなく、Web技術で統一することで開発効率を優先
- レスポンシブデザインとタッチUI前提で両対応を実現

#### 対象範囲
- packages/web 全体

#### 選択肢
- **Option A**: React + Vite + React Router（採用）
- **Option B**: React Native（iOS/Android）+ React Native Web
- **Option C**: Next.js（SSR）

#### 採用
Option A

#### 採用理由
- 開発速度が最速（既存の React 知識で開発可能）
- ビルド速度が速い（Vite）
- モバイルブラウザで動作（PWA化も可能）
- デプロイが容易（静的ホスティング）

#### 棄却理由
- **Option B**: 学習コストが高く、MVP 開発に時間がかかる
- **Option C**: SSR は MVP に不要、複雑度が増す

#### ASSUMPTION
- **ASSUMPTION-17**: モバイルブラウザでの体験がネイティブアプリと遜色ない
  - 検証方法: モバイルブラウザでのユーザーテスト
- **ASSUMPTION-18**: PWA化により、ホーム画面追加で疑似ネイティブ体験が可能
  - 検証方法: PWA manifest追加後のテスト

#### リスクと対策
- **リスク**: ネイティブアプリと比べてパフォーマンスが劣る
- **対策**: 必要に応じてReact Nativeに移行（段階的）
- **リスク**: オフライン機能が制限される
- **対策**: Service Worker導入（将来）

#### 成功条件と失敗条件
- **成功条件**: PC・タブレット・スマホで同一コードが動作する
- **失敗条件**: モバイル体験が著しく劣る場合はReact Native移行

#### ロールバック方針
React Native への移行（iOS優先）

#### 影響するドキュメント
- packages/web 全体

#### 関連リンク
なし

#### オーナー
開発チーム

#### ステータス
Accepted

#### 次回レビュー日
ユーザーテスト後（MVP運用開始後）

---

### DEC-20260208-009

#### 日付
2026-02-08

#### 決定内容
Day1体験はルールベース実装とし、AI生成を使用しない

#### 背景
- Day1は5分以内に価値体感が目標
- AI APIのレイテンシがユーザー体験を損なう可能性
- 初回体験は予測可能な動作が重要
- ルールベースでも十分な体験が提供できる

#### 対象範囲
- OnboardingPage（Domain選択、週目標設定）
- TodayTask別案生成（ルールベース）
- Recall問題生成（固定テンプレート）
- Day1CompletePage（完了画面）

#### 選択肢
- **Option A**: ルールベース実装（採用）
- **Option B**: AI生成（OpenAI API）
- **Option C**: ハイブリッド（簡単なものはルール、複雑なものはAI）

#### 採用
Option A

#### 採用理由
- **レイテンシゼロ**: ユーザーを待たせない、即座に応答
- **予測可能**: 初回体験は安定した動作が重要
- **コストゼロ**: MVP段階でAPIコスト不要
- **デバッグ容易**: ルールベースは動作検証が簡単
- **十分な品質**: 別案2つ、Recall 1問なら固定テンプレートで十分

#### 棄却理由
- **Option B**: レイテンシが1〜2秒発生、初回体験を損なう可能性
- **Option C**: 複雑度が増し、MVP開発速度が低下

#### ASSUMPTION
- **ASSUMPTION-19**: ルールベース別案でも提案受諾率が60%以上
  - 検証方法: Day1完了ユーザーの `today_offer_accept` 率を計測
  - 失敗条件: 受諾率が40%未満の場合、AI生成を検討
- **ASSUMPTION-20**: 固定テンプレートRecallでも学習効果がある
  - 検証方法: Day2以降の復帰率とRecall正答率を計測
  - 失敗条件: Day2復帰率が30%未満の場合、Recall設計を見直し

#### リスクと対策
- **リスク**: ルールベース別案がユーザーに刺さらない
- **対策**: 提案受諾率を計測し、60%未満ならAI生成に切り替え
- **リスク**: 固定テンプレートRecallが単調に感じられる
- **対策**: Day2以降はAI生成Recallに切り替え

#### 成功条件と失敗条件
- **成功条件**: Day1完了率が70%以上、Time-to-completeが5分以内
- **失敗条件**: Day1完了率が50%未満、または提案受諾率が40%未満

#### ロールバック方針
提案受諾率が40%未満の場合、Option B（AI生成）に段階的移行：
1. 別案生成のみAI化
2. Recall問題生成もAI化
3. フィードバックループで品質改善

#### 影響するドキュメント
- DAY1_FLOW.md
- packages/web/src/pages/OnboardingPage.tsx
- packages/web/src/pages/RecallPage.tsx
- packages/web/src/services/todayTaskService.ts

#### 関連リンク
- PRD-1 § 8.1（Today提示）
- Design-1 § 4.1（今日ビュー）
- Design-1 § 4.3（想起ビュー）

#### オーナー
開発チーム

#### ステータス
Accepted

#### 次回レビュー日
MVP運用開始後1週間（Day1完了率とTime-to-complete確認）

---

### DEC-20260208-010

#### 日付
2026-02-08

#### 決定内容
MVPではAI機能は実装せず、差し替え可能なインターフェースとスタブのみを用意する

#### 背景
- AI APIのコストとレイテンシが不確定
- MVP段階ではルールベースで十分な体験が提供できる
- 将来的なAI統合のために、差し替え可能な構造を用意する必要がある
- セキュリティ上、APIキーをクライアントに露出してはならない

#### 対象範囲
- 全体のAI関連機能
- Today Task生成、別案生成、Recall生成、詰まり救済
- サーバー側APIエンドポイント（将来実装）
- Feature Flag（AI_ENABLED）

#### 選択肢
- **Option A**: MVPでAI実装せず、スタブのみ（採用）
- **Option B**: MVPから OpenAI API を統合
- **Option C**: ハイブリッド（簡単な機能はルール、複雑な機能はAI）

#### 採用
Option A

#### 採用理由
1. **コスト最適化**
   - MVP段階でのAPI コスト不要
   - ユーザー数が不明な段階でコスト予測困難

2. **レイテンシ管理**
   - ルールベースはレイテンシゼロ
   - AI APIは1〜3秒のレイテンシが発生し、UX を損なう可能性

3. **予測可能性**
   - ルールベースは動作が予測可能、テストが容易
   - AI応答は非決定論的で、品質保証が困難

4. **段階的導入**
   - Feature Flagで機能単位に段階的にAI化可能
   - フィードバックを得てから AI統合を判断できる

5. **セキュリティ**
   - API キーをサーバー側のみで管理
   - クライアントに機密情報を露出しない

#### 棄却理由
- **Option B**: コストとレイテンシのリスクが高い、MVP段階では不要
- **Option C**: 複雑度が増し、開発速度が低下、境界が曖昧

#### ASSUMPTION
- **ASSUMPTION-21**: ルールベース実装でもユーザー満足度が60%以上
  - 検証方法: NPS、提案受諾率、継続率を計測
  - 失敗条件: NPS < 40、提案受諾率 < 40%、Day7継続率 < 30%

- **ASSUMPTION-22**: AI統合時のコストが月額$500以内に収まる
  - 検証方法: ユーザー数とAPI呼び出し頻度から試算
  - 失敗条件: 月額$1,000を超える場合は、機能を限定

#### リスクと対策
- **リスク**: ルールベースがユーザーに物足りないと感じられる
- **対策**: 提案受諾率とNPSを週次で計測、60%未満なら AI 統合を早める

- **リスク**: AI統合時の実装コストが大きい
- **対策**: インターフェースで抽象化済み、差し替えポイントが明確

- **リスク**: AI APIの障害や制限でサービスが停止する
- **対策**: フォールバック機構を用意、ルールベースに自動切り替え

#### 成功条件と失敗条件
- **成功条件**: 
  - AI_ENABLED=false でも全機能が動作
  - ユーザー満足度（NPS）が60以上
  - 提案受諾率が60%以上

- **失敗条件**: 
  - NPS < 40、提案受諾率 < 40%
  - Day7継続率 < 30%
  - → AI統合を検討

#### ロールバック方針
不要（スタブ実装は常に維持、AI統合後もフォールバックとして使用）

#### 影響するドキュメント
- docs/02_Design.md § 13（AI方針とアーキテクチャ）
- packages/web/src/services/aiService.ts
- .env.example（Feature Flag定義）
- .gitignore（機密管理）

#### 関連リンク
- DEC-20260208-009（Day1はルールベース実装）

#### オーナー
開発チーム

#### ステータス
Accepted

#### 次回レビュー日
MVP運用開始後1ヶ月（NPS、提案受諾率、継続率確認）

---

### DEC-20260208-011

#### 日付
2026-02-08

#### 決定内容
詰まり救済はテンプレート版で実装し、将来LLM（AI）に差し替え可能な設計とする

#### 背景
- P-104「詰まり＝設計で処理」を成立させる必要がある
- MVP段階ではLLMコストとレイテンシが不確定
- テンプレート版でも十分な救済効果が期待できる
- 将来的にLLM統合のために、差し替え可能な構造が必要

#### 対象範囲
- CoachService（詰まり救済サービス）
- StuckDetectionService（詰まり検知ロジック）
- StuckPage（詰まり画面）
- 計測イベント（stuck_*, rescue_*）

#### 選択肢
- **Option A**: テンプレート版、LLM差し替え可能（採用）
- **Option B**: 最初からLLM実装
- **Option C**: 詰まり救済なし（検知のみ）

#### 採用
Option A

#### 採用理由
1. **レイテンシゼロ**: テンプレート応答は即座に返る
2. **コスト最適化**: MVP段階でLLM APIコスト不要
3. **予測可能**: テンプレートは動作が予測可能、テストが容易
4. **十分な品質**: 理由別の救済オプション（3つ×4パターン）で基本的な救済が可能
5. **段階的導入**: Feature Flagで後からLLMに切り替え可能

#### 棄却理由
- **Option B**: LLMコストとレイテンシのリスク、MVP段階では不要
- **Option C**: 詰まり救済なしでは離脱率が高まる可能性

#### 実装詳細

**詰まり検知トリガー**:
1. Recall連続失敗（3問連続不正解）
2. 低自信度の連続（3問連続で自信度1-2）
3. Focus中断の連続（2回連続中断）

**詰まり理由（最大3択）**:
1. 難しい（too_hard）
2. 何から手をつければよいか分からない（unclear_how）
3. 時間が足りない（no_time）

**救済アクション（理由別に最大3択）**:
1. split（小さく分割する）- タスクを1分版に短縮
2. easier（易しくする）- 難易度を1段階下げる
3. example（例を見る）- 「例：〜」タイトルに変更
4. alternate_route（別ルートにする）- 復習タスクに変更

**テンプレート一覧**:
- 詳細: `docs/STUCK_RESCUE_TEMPLATES.md`

#### AI差し替えポイント

**現在（MVP）**:
```typescript
export const coachService = new TemplateCoachService();
```

**将来（LLM統合後）**:
```typescript
export const coachService = 
  import.meta.env.VITE_AI_ENABLED === 'true'
    ? new LLMCoachService()
    : new TemplateCoachService();
```

**差し替え箇所**:
- `packages/web/src/services/coachService.ts`
- インターフェース `ICoachService` は変更不要
- `generateRescueOptions` と `applyRescueAction` を実装

#### ASSUMPTION
- **ASSUMPTION-23**: テンプレート救済でも救済採用率が50%以上
  - 検証方法: `stuck_help_applied` / `stuck_detected` の比率を計測
  - 失敗条件: 採用率が30%未満の場合、LLM統合を検討

- **ASSUMPTION-24**: 救済後の完了率が通常時の80%以上
  - 検証方法: 救済後の `learning_session_complete` 率を計測
  - 失敗条件: 完了率が50%未満の場合、救済内容を見直し

#### リスクと対策
- **リスク**: テンプレート救済が画一的で効果が低い
- **対策**: 救済採用率を計測し、30%未満なら LLM統合を早める

- **リスク**: 詰まり検知の精度が低い（誤検知または見逃し）
- **対策**: 検知ロジックを段階的に調整、閾値を最適化

- **リスク**: 救済アクション適用後も詰まりが解消しない
- **対策**: 救済後の完了率を計測、50%未満なら救済内容を改善

#### 成功条件と失敗条件
- **成功条件**: 
  - 救済採用率が50%以上
  - 救済後の完了率が通常時の80%以上
  - 詰まりから再開までの時間が平均60秒以内

- **失敗条件**: 
  - 救済採用率が30%未満
  - 救済後の完了率が50%未満
  - → LLM統合を検討、またはテンプレート内容を改善

#### ロールバック方針
不要（テンプレート実装は常に維持、LLM統合後もフォールバックとして使用）

#### 影響するドキュメント
- docs/STUCK_RESCUE_TEMPLATES.md（テンプレート一覧）
- packages/web/src/services/coachService.ts
- packages/web/src/services/stuckDetectionService.ts
- packages/web/src/pages/StuckPage.tsx

#### 関連リンク
- P-104（詰まり＝設計で処理）
- DEC-20260208-010（AI方針）

#### オーナー
開発チーム

#### ステータス
Accepted

#### 次回レビュー日
MVP運用開始後2週間（救済採用率、救済後完了率確認）

---

### DEC-20260208-012：A/B実験土台（割付・フラグ・期間・成功/失敗条件）

#### 決定日
2026-02-08

#### 決定内容
A/B実験の土台を実装し、ユーザー単位の固定割付とハッシュベースの安定性を保証する

1. **実験フラグ管理**
   - ユーザー単位で固定割付（同一ユーザーが揺れない）
   - 実験ID、割付群、開始日、終了日を保持
   - 実験が無効な場合は既定値（Control）で動作
   - 割付はハッシュベースで決定論的に生成（ユーザーID + 実験ID）

2. **実装した実験（MVP: 2本）**
   - X-001：Today提示の強度（文言の強さを変える）
   - X-002：Recallスキップ導線の強調（UI差分を変える）

3. **成功/失敗条件の判定機能**
   - 指標ごとのベースライン、MDE（最小検出効果）を定義
   - 判定ロジックを `experimentService.evaluateExperiment()` で実装
   - 統計検定（t検定、z検定、p値計算）は省略（MVP）
   - MDEを超える改善があるかどうかの単純な判定のみ実装

4. **実験情報のイベント統合**
   - すべてのアナリティクスイベントに `experiment_id` と `variant_id` を付与
   - 実験ごとの指標集計を可能にする

#### 背景・理由
- A/B実験でプロダクトの仮説を検証し、継続的に改善するため
- ユーザー体験を最大化するための判断材料を得るため
- 統計的に有意な差を検出し、誤った意思決定を避けるため

#### 代替案
1. **外部ABテストツール（Optimizely、Google Optimizeなど）**
   - メリット：統計検定が自動化、UIエディタで簡単
   - デメリット：外部依存、コスト増加、カスタマイズ制限
   - 却下理由：MVP段階では過剰、自前実装で学びを得る

2. **ランダム割付（サーバー側で動的生成）**
   - メリット：完全なランダム性
   - デメリット：サーバー必須、実装複雑、ユーザーが揺れる可能性
   - 却下理由：MVP段階ではクライアント側で完結したい

#### 影響範囲
- **新規ファイル**:
  - `packages/web/src/services/experimentService.ts`（実験管理サービス）
- **変更ファイル**:
  - `packages/web/src/App.tsx`（実験情報のアナリティクス統合）
  - `packages/web/src/components/TodayCard.tsx`（X-001: UI差分実装）
  - `packages/web/src/pages/TodayPage.tsx`（X-001: 割付取得）
  - `packages/web/src/pages/RecallPage.tsx`（X-002: UI差分実装と割付取得）
- **ドキュメント**:
  - `docs/04_Experiments.md`（実装済み実験詳細を追加）

#### 制約・トレードオフ
- **統計検定未実装**: p値、信頼区間、検出力計算は省略（MVP）
  - トレードオフ: 正確な判定には外部ツールまたはライブラリ（jStat）が必要
- **クライアント側の割付**: サーバー側の実装を待たずに実験を開始できる
  - トレードオフ: 複雑な条件（購入履歴、デバイスタイプなど）での割付は困難
- **LocalStorageでの保存**: 簡易実装でオフライン対応
  - トレードオフ: ユーザーがLocalStorageをクリアすると割付が変わる

#### 成功条件
- X-001（Today提示の強度）:
  - Time-to-start が -10秒以上改善
  - 提案受諾率が維持（-5%pt以内）
  - Day2/Day7継続率が悪化しない（-5%pt以内）

- X-002（Recallスキップ導線の強調）:
  - Recallスキップ率が上昇
  - 初回完了率が維持（-5%pt以内）
  - Day2継続率が +5%pt以上改善
  - Focus完了率が維持（-5%pt以内）

#### ロールバック方針
- 実験が失敗した場合、`experimentService.addExperiment()` で `isActive: false` に変更
- 割付群はすべて `disabled` になり、Control群と同じ動作になる
- UI差分のロールバックは不要（条件分岐で自動的にControl群の挙動に戻る）

#### 影響するドキュメント
- docs/04_Experiments.md（実装済み実験詳細）
- docs/03_Metrics.md（実験イベントの定義は既存）

#### 関連リンク
- DEC-20260208-002（アナリティクス実装）
- docs/04_Experiments.md § 1 統計的基準とサンプルサイズ設計
- docs/04_Experiments.md § 2 早期停止ルール

#### オーナー
開発チーム

#### ステータス
Accepted

#### 次回レビュー日
実験開始（2026-02-10）から7日後（2026-02-17）に先行指標を確認

---

## 6. 関連ドキュメント

- **00_Principles.md**：サービス設計原則
- **01_PRD.md**：プロダクト要求仕様
- **02_Design.md**：UX設計仕様
- **03_Metrics.md**：計測定義とイベント設計
- **04_Experiments.md**：A/B実験仕様

---

## 7. 更新履歴

| 日付 | Version | 変更内容 | 担当者 |
|---|---|---|---|
| 2026-02-08 | 1.2 | DEC-20260208-012（A/B実験土台）を追加 | - |
| 2026-02-08 | 1.1 | 確定した決定事項4件を追加、インデックス更新、目次追加 | - |
| - | 1.0 | 初版作成（テンプレートのみ） | - |
